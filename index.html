<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Booth</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #212529; color: white; overflow-x: hidden; }
        .mirror-x { transform: scaleX(-1); }
        .cursor-pointer { cursor: pointer; }
        
        /* Flash Animation */
        @keyframes flash {
            0% { opacity: 0.8; }
            100% { opacity: 0; }
        }
        .animate-flash { animation: flash 0.5s ease-out forwards; }
        
        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: .8; transform: scale(1.05); }
        }
        .animate-pulse { animation: pulse 2s infinite; }

        /* Bounce Animation */
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0,0,0.2,1); }
        }
        .animate-bounce { animation: bounce 1s infinite; }

        /* Strip Browsing Animations */
        .strip-container {
            transition: transform 0.3s ease-out, opacity 0.2s ease-out;
        }
        .slide-out-left {
            transform: translateX(-50px) rotate(-2deg) !important;
            opacity: 0;
        }
        .slide-out-right {
            transform: translateX(50px) rotate(2deg) !important;
            opacity: 0;
        }
        .slide-in-start-left {
            transform: translateX(-50px) !important;
            opacity: 0;
        }
        .slide-in-start-right {
            transform: translateX(50px) !important;
            opacity: 0;
        }

        /* Utilities */
        .hidden { display: none !important; }
        
        /* Print Area Default (Hidden on Screen) */
        #print-area { display: none; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                display: flex !important; /* Force flex display during print */
                position: fixed; left: 0; top: 0; width: 100%; height: 100%;
                align-items: center; justify-content: center;
                margin: 0; padding: 0;
                background: white;
                z-index: 9999;
            }
            img.print-img { width: 100%; height: 100%; object-fit: contain; }
            @page { size: 4in 6in; margin: 0; }
        }
    </style>
</head>
<body>

    <!-- VIEW: SETUP (HOME) -->
    <div id="view-setup" class="container min-vh-100 d-flex flex-column align-items-center justify-content-center py-5">
        <div class="text-center mb-5">
            <h1 class="display-3 fw-bold mb-3 text-warning">Party Booth</h1>
            <p class="text-white-50 fs-5">Configure your event settings below.</p>
        </div>

        <div class="card bg-dark border-secondary shadow-lg w-100" style="max-width: 500px;">
            <div class="card-body p-4">
                <!-- Preview -->
                <div class="ratio ratio-4x3 bg-black rounded overflow-hidden border border-secondary mb-4 position-relative">
                    <video id="preview-video" autoplay playsinline muted class="w-100 h-100 object-fit-cover mirror-x"></video>
                </div>

                <!-- Controls -->
                <div class="mb-4">
                    <label class="form-label text-white-50 small fw-bold">Select Camera</label>
                    <select id="camera-select" class="form-select bg-secondary text-white border-0 mb-3"></select>

                    <label class="form-label text-white-50 small fw-bold">Customize Event Logo</label>
                    <div class="btn-group w-100 mb-3">
                        <input type="radio" class="btn-check" name="logo-mode" id="mode-text" autocomplete="off" checked>
                        <label class="btn btn-outline-secondary text-white" for="mode-text">Text Label</label>

                        <input type="radio" class="btn-check" name="logo-mode" id="mode-image" autocomplete="off">
                        <label class="btn btn-outline-secondary text-white" for="mode-image">Upload Logo</label>
                    </div>

                    <div id="input-text-group" class="mb-3">
                        <input type="text" id="event-text" class="form-control bg-secondary text-white border-0 py-3" value="SUMMER BASH 2025" placeholder="Event Name">
                    </div>
                    <div id="input-image-group" class="hidden mb-3">
                        <input type="file" id="logo-upload" accept="image/*" class="d-none">
                        <label for="logo-upload" class="d-flex align-items-center justify-content-center w-100 py-3 bg-secondary bg-opacity-25 border border-secondary border-dashed rounded cursor-pointer text-white-50">
                            <i data-lucide="upload" class="me-2"></i> <span id="logo-status">Choose Image...</span>
                        </label>
                    </div>

                    <!-- Auto Save Configuration -->
                    <label class="form-label text-white-50 small fw-bold">Auto-Save Location</label>
                    <button id="btn-select-folder" class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center gap-2 py-3 border-secondary text-white">
                        <i data-lucide="folder-open"></i> <span id="folder-status">Select Folder for Auto-Save</span>
                    </button>
                    <div class="form-text text-white-50 small mt-1">If selected, images will save here automatically.</div>
                </div>

                <button id="btn-launch" class="btn btn-primary w-100 py-3 rounded-3 fs-5 fw-bold d-flex align-items-center justify-content-center gap-2 shadow">
                    <i data-lucide="maximize"></i> Launch Photobooth
                </button>
            </div>
        </div>
    </div>

    <!-- VIEW: BOOTH START (ATTRACT SCREEN) -->
    <div id="view-attract" class="hidden position-fixed top-0 start-0 w-100 h-100 bg-black d-flex flex-column align-items-center justify-content-center overflow-hidden">
        <div class="position-absolute top-0 start-0 w-100 h-100 opacity-50">
            <video id="attract-video" autoplay playsinline muted class="w-100 h-100 object-fit-cover mirror-x"></video>
        </div>
        <div class="position-relative z-1 d-flex flex-column align-items-center">
            <h1 id="display-event-name" class="display-1 fw-bold text-white mb-5 text-center" style="text-shadow: 0 4px 4px rgba(0,0,0,0.8)">EVENT</h1>
            <button id="btn-start" class="btn btn-light btn-lg rounded-pill px-5 py-3 fs-2 fw-bold shadow animate-pulse">
                Touch to Start
            </button>
        </div>
    </div>

    <!-- VIEW: CAPTURE (COUNTDOWN & FLASH) -->
    <div id="view-capture" class="hidden position-fixed top-0 start-0 w-100 h-100 bg-black z-3 d-flex flex-column align-items-center justify-content-center">
        <div class="position-relative w-100 border border-4 border-dark rounded-4 overflow-hidden shadow-lg" style="max-width: 800px; aspect-ratio: 540/330;">
            <video id="capture-video" autoplay playsinline muted class="w-100 h-100 object-fit-cover mirror-x"></video>
            
            <div id="flash-overlay" class="position-absolute top-0 start-0 w-100 h-100 bg-white hidden" style="pointer-events: none;"></div>

            <!-- Countdown: Positioned Bottom Right -->
            <div id="countdown-overlay" class="position-absolute bottom-0 end-0 p-4 hidden" style="pointer-events: none;">
                <div id="countdown-text" class="text-white fw-bold animate-pulse" style="font-size: 8rem; text-shadow: 0 0 15px rgba(0,0,0,0.8); line-height: 1;">3</div>
            </div>
            
            <div class="position-absolute bottom-0 start-0 w-100 mb-4 d-flex justify-content-center gap-3">
                <div id="dot-1" class="rounded-circle bg-secondary" style="width: 1rem; height: 1rem;"></div>
                <div id="dot-2" class="rounded-circle bg-secondary" style="width: 1rem; height: 1rem;"></div>
                <div id="dot-3" class="rounded-circle bg-secondary" style="width: 1rem; height: 1rem;"></div>
                <div id="dot-4" class="rounded-circle bg-secondary" style="width: 1rem; height: 1rem;"></div>
            </div>
        </div>
        <div class="mt-4 fs-3 fw-medium text-white text-uppercase">
            Pose for photo <span id="current-shot-num">1</span> of 4
        </div>
    </div>

    <!-- VIEW: PROCESSING -->
    <div id="view-processing" class="hidden position-fixed top-0 start-0 w-100 h-100 bg-dark z-3 d-flex flex-column align-items-center justify-content-center">
        <div class="text-primary mb-4 spinner-border" style="width: 4rem; height: 4rem;"></div>
        <h2 class="fs-2 fw-bold animate-pulse">Developing Photos...</h2>
    </div>

    <!-- VIEW: RESULT -->
    <div id="view-result" class="hidden min-vh-100 d-flex flex-column align-items-center justify-content-center p-3 bg-dark">
        <div class="container" style="max-width: 1200px;">
            <div class="row g-5 align-items-center">
                
                <!-- Left Column: Image + Carousel Controls -->
                <div class="col-lg-6 d-flex flex-column align-items-center">
                    
                    <!-- Strip Image Container -->
                    <div id="strip-container" class="strip-container bg-white p-2 shadow-lg rounded mb-4" style="transform: rotate(1deg);">
                        <img id="final-image" src="" alt="Strip" class="img-fluid border" style="max-height: 60vh; width: auto;">
                    </div>

                    <!-- Customization Card (Moved below strip) -->
                    <div class="card bg-secondary bg-opacity-10 border-secondary w-100 mb-4" style="max-width: 450px;">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-center gap-2 mb-3 small fw-bold text-white-50">
                                <i data-lucide="layout-template"></i> Choose Strip Theme
                            </div>
                            
                            <div class="d-flex align-items-center justify-content-between bg-dark rounded-4 p-2 border border-secondary">
                                <button id="btn-prev-style" class="btn btn-link text-white p-0 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                    <i data-lucide="chevron-left" style="width: 28px; height: 28px;"></i>
                                </button>
                                
                                <div class="text-center flex-grow-1">
                                    <span id="current-style-name" class="fw-bold fs-4 d-block text-white mb-1">Classic White</span>
                                    <div class="d-flex justify-content-center gap-1" id="style-dots">
                                        <!-- Dots injected by JS -->
                                    </div>
                                </div>

                                <button id="btn-next-style" class="btn btn-link text-white p-0 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                    <i data-lucide="chevron-right" style="width: 28px; height: 28px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Actions & Details -->
                <div class="col-lg-6">
                    
                    <!-- Static QR Code Display -->
                    <div id="result-qr-container" class="d-flex align-items-center mb-4 p-3 bg-white text-dark rounded shadow-sm border" style="max-width: 100%; width: fit-content;">
                        <div id="static-qr-code"></div>
                        <div class="ms-3">
                            <h5 class="fw-bold mb-1">Get Your Photos</h5>
                            <p class="mb-0 small text-muted">Scan to view Google Drive Gallery</p>
                        </div>
                    </div>

                    <h2 class="display-5 fw-bold mb-2">Ready to Print!</h2>
                    <p class="text-white-50 mb-4">Your 4R photo is ready. It contains two 2x6" strips.</p>
                    
                    <div id="auto-save-toast" class="alert alert-success d-flex align-items-center hidden" role="alert">
                        <i data-lucide="check-circle" class="me-2"></i>
                        <div>Image saved automatically!</div>
                    </div>

                    <div class="d-grid gap-3">
                        <button onclick="window.print()" class="btn btn-primary btn-lg fw-bold d-flex align-items-center justify-content-center gap-2 shadow">
                            <i data-lucide="printer"></i> Print Photo
                        </button>
                        <a id="btn-download" href="#" class="btn btn-secondary fw-semibold py-2 d-flex align-items-center justify-content-center gap-2">
                            <i data-lucide="download"></i> Save Digital Copy (Manual)
                        </a>
                        <button id="btn-new-session" class="btn btn-outline-light fw-semibold py-2 d-flex align-items-center justify-content-center gap-2 mt-2">
                            <i data-lucide="refresh-ccw"></i> New Session
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Area -->
    <div id="print-area">
        <img id="print-img" class="print-img">
    </div>

    <!-- Hidden Canvas -->
    <canvas id="crop-canvas" class="hidden"></canvas>
    <canvas id="final-canvas" class="hidden"></canvas>

    <!-- LOGIC -->
    <script>
        lucide.createIcons();

        // State
        let stream = null;
        let photos = [];
        let config = {
            text: "SUMMER BASH 2025",
            logo: null,
            mode: 'text',
            deviceId: null,
            styleIndex: 0 // Default to first style
        };
        // Global handle for the folder (persists in memory during SPA session)
        let saveDirectoryHandle = null;

        // --- STRIP STYLES DEFINITION ---
        const stripStyles = [
            {
                name: 'Classic White',
                textColor: '#222',
                borderColor: '#eee',
                cutLine: '#ccc',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, w, h);
                }
            },
            {
                name: 'Cinema Film',
                textColor: '#fff',
                borderColor: '#333',
                cutLine: '#555',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#111'; // Dark film background
                    ctx.fillRect(0, 0, w, h);
                    
                    // Draw Sprocket holes on sides of strip
                    ctx.fillStyle = '#fff';
                    const holeW = 15;
                    const holeH = 10;
                    const spacing = 30;
                    
                    // Left and Right holes for Left Strip
                    for(let y=20; y<h; y+=spacing) {
                        ctx.fillRect(10, y, holeW, holeH); // Left edge of canvas
                        ctx.fillRect(575, y, holeW, holeH); // Right edge of left strip
                        
                        ctx.fillRect(610, y, holeW, holeH); // Left edge of right strip
                        ctx.fillRect(1175, y, holeW, holeH); // Right edge of canvas
                    }
                }
            },
            {
                name: 'Galaxy',
                textColor: '#fff',
                borderColor: 'rgba(255,255,255,0.3)',
                cutLine: '#4b0082',
                draw: (ctx, w, h) => {
                    const grd = ctx.createLinearGradient(0, 0, 0, h);
                    grd.addColorStop(0, "#0f0c29");
                    grd.addColorStop(0.5, "#302b63");
                    grd.addColorStop(1, "#24243e");
                    ctx.fillStyle = grd;
                    ctx.fillRect(0, 0, w, h);
                    ctx.fillStyle = '#fff';
                    for(let i=0; i<150; i++) {
                        ctx.beginPath();
                        ctx.arc(Math.random()*w, Math.random()*h, Math.random()*2, 0, Math.PI*2);
                        ctx.fill();
                    }
                }
            },
            {
                name: 'Love Hearts',
                textColor: '#b91c1c', // red-700
                borderColor: '#fecaca', // red-200
                cutLine: '#fca5a5',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#fff1f2'; // rose-50
                    ctx.fillRect(0, 0, w, h);
                    
                    // Draw random hearts pattern
                    ctx.fillStyle = 'rgba(253, 164, 175, 0.4)'; // rose-300 transparent
                    for(let i=0; i<100; i++) {
                        const x = Math.random() * w;
                        const y = Math.random() * h;
                        const size = 10 + Math.random() * 20;
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.bezierCurveTo(x - size/2, y - size/2, x - size, y + size/3, x, y + size);
                        ctx.bezierCurveTo(x + size, y + size/3, x + size/2, y - size/2, x, y);
                        ctx.fill();
                    }
                }
            },
            {
                name: 'Hazard',
                textColor: '#000',
                borderColor: '#000',
                cutLine: '#000',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#facc15'; // yellow-400
                    ctx.fillRect(0, 0, w, h);
                    ctx.fillStyle = '#000';
                    for(let i=-w; i<w+h; i+=60) {
                        ctx.beginPath();
                        ctx.moveTo(i, 0);
                        ctx.lineTo(i+30, 0);
                        ctx.lineTo(i-h+30, h);
                        ctx.lineTo(i-h, h);
                        ctx.fill();
                    }
                }
            },
            {
                name: 'Retro Pop',
                textColor: '#b45309', // amber-700
                borderColor: '#fbbf24', // amber-400
                cutLine: '#f59e0b',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#fffbeb'; // amber-50
                    ctx.fillRect(0, 0, w, h);
                    ctx.fillStyle = '#fcd34d'; // amber-300
                    for(let y=0; y<h; y+=40) {
                        for(let x=0; x<w; x+=40) {
                            ctx.beginPath();
                            ctx.arc(x+20, y+20, 10, 0, Math.PI*2);
                            ctx.fill();
                        }
                    }
                }
            },
            {
                name: 'Neon Night',
                textColor: '#0f0',
                borderColor: '#0f0',
                cutLine: '#0f0',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#0f172a'; // slate-900
                    ctx.fillRect(0, 0, w, h);
                    ctx.strokeStyle = 'rgba(34, 197, 94, 0.3)'; // green-500 low opacity
                    ctx.lineWidth = 2;
                    // Grid pattern
                    for(let i=0; i<w; i+=60) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,h); ctx.stroke(); }
                    for(let i=0; i<h; i+=60) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(w,i); ctx.stroke(); }
                }
            },
            {
                name: 'Picnic',
                textColor: '#b91c1c',
                borderColor: 'rgba(185, 28, 28, 0.2)',
                cutLine: '#fca5a5',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, w, h);
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.3)'; // red-500 transparent
                    const size = 40;
                    for(let x=0; x<w; x+=size) ctx.fillRect(x, 0, size/2, h);
                    for(let y=0; y<h; y+=size) ctx.fillRect(0, y, w, size/2);
                }
            },
            {
                name: 'Blueprint',
                textColor: '#fff',
                borderColor: 'rgba(255,255,255,0.5)',
                cutLine: '#93c5fd',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#1e3a8a'; // blue-900
                    ctx.fillRect(0, 0, w, h);
                    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                    ctx.lineWidth = 1;
                    const grid = 40;
                    for(let x=0; x<w; x+=grid) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
                    for(let y=0; y<h; y+=grid) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
                }
            },
            {
                name: 'Elegant Marble',
                textColor: '#374151', // gray-700
                borderColor: '#e5e7eb', // gray-200
                cutLine: '#9ca3af',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#f9fafb';
                    ctx.fillRect(0, 0, w, h);
                    ctx.strokeStyle = 'rgba(0,0,0,0.08)';
                    ctx.lineWidth = 50;
                    ctx.lineCap = 'round';
                    // Draw random marble veins
                    for(let i=0; i<20; i++) {
                        ctx.beginPath();
                        ctx.moveTo(Math.random()*w, Math.random()*h);
                        ctx.bezierCurveTo(Math.random()*w, Math.random()*h, Math.random()*w, Math.random()*h, Math.random()*w, Math.random()*h);
                        ctx.stroke();
                    }
                }
            },
            {
                name: 'Confetti',
                textColor: '#222',
                borderColor: 'rgba(0,0,0,0.1)',
                cutLine: '#ccc',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, w, h);
                    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
                    for(let i=0; i<300; i++) {
                        ctx.fillStyle = colors[Math.floor(Math.random()*colors.length)];
                        ctx.beginPath();
                        ctx.arc(Math.random()*w, Math.random()*h, Math.random()*5+2, 0, Math.PI*2);
                        ctx.fill();
                    }
                }
            },
            {
                name: 'Old Paper',
                textColor: '#451a03',
                borderColor: 'rgba(69, 26, 3, 0.2)',
                cutLine: '#8c7e73',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#f5f5dc'; // beige
                    ctx.fillRect(0, 0, w, h);
                    ctx.fillStyle = 'rgba(0,0,0,0.03)';
                    for(let i=0; i<5000; i++) {
                        ctx.fillRect(Math.random()*w, Math.random()*h, 2, 2);
                    }
                }
            },
            {
                name: 'Vaporwave',
                textColor: '#0ff',
                borderColor: '#f0f',
                cutLine: '#0ff',
                draw: (ctx, w, h) => {
                    const grd = ctx.createLinearGradient(0, 0, 0, h);
                    grd.addColorStop(0, "#240046");
                    grd.addColorStop(1, "#7b2cbf");
                    ctx.fillStyle = grd;
                    ctx.fillRect(0, 0, w, h);
                    ctx.strokeStyle = 'rgba(0, 255, 255, 0.3)';
                    ctx.lineWidth = 2;
                    // Sun
                    ctx.fillStyle = 'rgba(255, 0, 255, 0.5)';
                    ctx.beginPath();
                    ctx.arc(w/2, h, 300, 0, Math.PI*2);
                    ctx.fill();
                    // Grid
                    for(let y=h/2; y<h; y+=40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
                    for(let x=0; x<w; x+=60) { ctx.beginPath(); ctx.moveTo(w/2, h/2); ctx.lineTo(x- (x-w/2)*2, h); ctx.stroke(); } 
                }
            },
            {
                name: 'Camouflage',
                textColor: '#fff',
                borderColor: 'rgba(0,0,0,0.3)',
                cutLine: '#555',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#556b2f'; // olive
                    ctx.fillRect(0, 0, w, h);
                    const colors = ['#8b4513', '#000000', '#2e8b57'];
                    for(let i=0; i<20; i++) {
                        ctx.fillStyle = colors[i%3];
                        ctx.beginPath();
                        let x = Math.random()*w;
                        let y = Math.random()*h;
                        ctx.moveTo(x, y);
                        for(let j=0; j<5; j++) {
                            ctx.bezierCurveTo(x+Math.random()*200-100, y+Math.random()*200-100, x+Math.random()*200-100, y+Math.random()*200-100, x+Math.random()*200-100, y+Math.random()*200-100);
                        }
                        ctx.fill();
                    }
                }
            },
            {
                name: 'Denim',
                textColor: '#fff',
                borderColor: '#fbbf24', // stitching color
                cutLine: '#fbbf24',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#1e3a8a'; // dark blue
                    ctx.fillRect(0, 0, w, h);
                    // Texture
                    ctx.fillStyle = 'rgba(255,255,255,0.05)';
                    for(let i=0; i<w; i+=2) ctx.fillRect(i, 0, 1, h);
                    for(let i=0; i<h; i+=2) ctx.fillRect(0, i, w, 1);
                    
                    // Stitching border around each strip area roughly
                    ctx.strokeStyle = '#fbbf24'; // orange thread
                    ctx.setLineDash([15, 10]);
                    ctx.lineWidth = 4;
                    // Left strip border
                    ctx.strokeRect(20, 20, 560, 1760);
                    // Right strip border
                    ctx.strokeRect(620, 20, 560, 1760);
                    ctx.setLineDash([]);
                }
            },
            {
                name: 'Rainbow',
                textColor: '#222',
                borderColor: '#fff',
                cutLine: '#fff',
                draw: (ctx, w, h) => {
                    const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];
                    const step = h / colors.length;
                    colors.forEach((c, i) => {
                        ctx.fillStyle = c;
                        ctx.fillRect(0, i*step, w, step+1);
                    });
                }
            },
            {
                name: 'Midnight',
                textColor: '#fff',
                borderColor: 'rgba(255,255,255,0.2)',
                cutLine: '#555',
                draw: (ctx, w, h) => {
                    ctx.fillStyle = '#111827';
                    ctx.fillRect(0, 0, w, h);
                }
            },
            {
                name: 'Sunset',
                textColor: '#fff',
                borderColor: 'rgba(255,255,255,0.2)',
                cutLine: '#fff',
                draw: (ctx, w, h) => {
                    const grd = ctx.createLinearGradient(0, 0, 0, h);
                    grd.addColorStop(0, "#f43f5e");
                    grd.addColorStop(1, "#fbbf24");
                    ctx.fillStyle = grd;
                    ctx.fillRect(0, 0, w, h);
                }
            }
        ];

        // DOM Elements
        const views = {
            setup: document.getElementById('view-setup'),
            attract: document.getElementById('view-attract'),
            capture: document.getElementById('view-capture'),
            processing: document.getElementById('view-processing'),
            result: document.getElementById('view-result')
        };
        const videoEls = [
            document.getElementById('preview-video'), 
            document.getElementById('attract-video'), 
            document.getElementById('capture-video')
        ];

        // Init
        async function init() {
            await getCameras();
            startCamera();
            setupStyleCarousel();
            setupStaticQR();
            
            // Check URL param for booth mode
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'booth') {
                loadConfig();
                switchView('attract');
            }
        }
        
        function switchView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            if(viewName === 'attract' || viewName === 'capture' || viewName === 'setup') {
                startCamera(config.deviceId);
            }
        }

        // QR Code Setup
        function setupStaticQR() {
            const qrContainer = document.getElementById('static-qr-code');
            const driveLink = "https://drive.google.com/drive/folders/1lEarwDNVilpc9xGBAwzHJfg4ZYTRTmoB?usp=sharing";
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: driveLink,
                width: 200, // Made bigger per request
                height: 200
            });
        }

        // Camera Logic
        async function getCameras() {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true }); // Request perm
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                const select = document.getElementById('camera-select');
                select.innerHTML = '';
                videoDevices.forEach((d, i) => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.text = d.label || `Camera ${i+1}`;
                    select.appendChild(opt);
                });
                select.onchange = (e) => startCamera(e.target.value);
            } catch(e) { console.error(e); }
        }

        async function startCamera(deviceId = null) {
            if (stream && stream.active) {
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                if (!deviceId || (settings.deviceId === deviceId)) {
                    videoEls.forEach(v => {
                        if (v.srcObject !== stream) {
                            v.srcObject = stream;
                            v.play().catch(e => console.log("Play error", e));
                        }
                    });
                    return; 
                }
            }

            if(stream) stream.getTracks().forEach(t => t.stop());
            
            const constraints = {
                video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' }
            };
            if(deviceId) constraints.video.deviceId = { exact: deviceId };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoEls.forEach(v => v.srcObject = stream);
                if(deviceId) config.deviceId = deviceId;
            } catch(err) { console.error("Cam error", err); }
        }

        // Setup Logic
        document.getElementById('mode-text').onchange = () => {
            config.mode = 'text';
            document.getElementById('input-text-group').classList.remove('hidden');
            document.getElementById('input-image-group').classList.add('hidden');
        };
        document.getElementById('mode-image').onchange = () => {
            config.mode = 'image';
            document.getElementById('input-text-group').classList.add('hidden');
            document.getElementById('input-image-group').classList.remove('hidden');
        };
        document.getElementById('event-text').oninput = (e) => config.text = e.target.value;
        
        document.getElementById('logo-upload').onchange = (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    config.logo = evt.target.result;
                    document.getElementById('logo-status').innerText = "Logo Uploaded!";
                    document.getElementById('logo-status').classList.add('text-success');
                };
                reader.readAsDataURL(file);
            }
        };

        // --- FOLDER SELECTION LOGIC ---
        document.getElementById('btn-select-folder').onclick = async () => {
            if ('showDirectoryPicker' in window) {
                try {
                    saveDirectoryHandle = await window.showDirectoryPicker({
                        mode: 'readwrite'
                    });
                    const statusSpan = document.getElementById('folder-status');
                    statusSpan.innerText = `Auto-Save to: ${saveDirectoryHandle.name}`;
                    statusSpan.classList.add('text-success', 'fw-bold');
                } catch (err) {
                    console.log("Folder selection cancelled or failed", err);
                }
            } else {
                alert("Your browser does not support automatic folder saving. Please use Chrome or Edge.");
            }
        };

        // Launch Logic
        document.getElementById('btn-launch').onclick = () => {
            config.deviceId = document.getElementById('camera-select').value;
            localStorage.setItem('pb_config', JSON.stringify(config));
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }
            loadConfig();
            switchView('attract');
        };

        function loadConfig() {
            const saved = localStorage.getItem('pb_config');
            if(saved) config = JSON.parse(saved);
            document.getElementById('display-event-name').innerText = config.text;
        }

        // Booth Logic
        document.getElementById('btn-start').onclick = () => {
            photos = [];
            runSequence(1);
        };

        function runSequence(shotNum) {
            if(shotNum > 4) {
                switchView('processing');
                setTimeout(generateStrip, 1000);
                return;
            }

            switchView('capture');
            document.getElementById('current-shot-num').innerText = shotNum;
            
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                dot.className = i < shotNum ? 'rounded-circle bg-success' : (i===shotNum ? 'rounded-circle bg-white animate-bounce' : 'rounded-circle bg-secondary');
            }

            let count = 3;
            const cntEl = document.getElementById('countdown-text');
            const cntOverlay = document.getElementById('countdown-overlay');
            cntOverlay.classList.remove('hidden');
            cntEl.innerText = count;

            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    cntEl.innerText = count;
                } else {
                    clearInterval(timer);
                    cntOverlay.classList.add('hidden');
                    takePhoto(shotNum);
                }
            }, 1000);
        }

        function takePhoto(shotNum) {
            const flash = document.getElementById('flash-overlay');
            flash.classList.remove('hidden');
            flash.classList.add('animate-flash');
            
            const video = document.getElementById('capture-video');
            const canvas = document.getElementById('crop-canvas');
            const ctx = canvas.getContext('2d');
            
            const targetW = 1080;
            const targetH = 660; 
            const targetRatio = targetW / targetH;

            canvas.width = targetW;
            canvas.height = targetH;
            
            const vidW = video.videoWidth;
            const vidH = video.videoHeight;
            const vidRatio = vidW / vidH;
            
            let sW, sH, sX, sY;

            if (vidRatio > targetRatio) {
                sH = vidH;
                sW = vidH * targetRatio;
                sX = (vidW - sW) / 2;
                sY = 0;
            } else {
                sW = vidW;
                sH = vidW / targetRatio;
                sX = 0;
                sY = (vidH - sH) / 2;
            }
            
            ctx.translate(targetW, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, sX, sY, sW, sH, 0, 0, targetW, targetH);
            
            photos.push(canvas.toDataURL('image/jpeg', 0.9));

            setTimeout(() => {
                flash.classList.remove('animate-flash');
                flash.classList.add('hidden');
                runSequence(shotNum + 1);
            }, 500);
        }

        // Customization Logic (New Carousel)
        function setupStyleCarousel() {
            updateCarouselUI();

            document.getElementById('btn-prev-style').onclick = () => {
                const container = document.getElementById('strip-container');
                // Animate Out Left
                container.classList.add('slide-out-left');
                
                setTimeout(() => {
                    config.styleIndex = (config.styleIndex - 1 + stripStyles.length) % stripStyles.length;
                    updateCarouselUI();
                    generateStrip(() => {
                        container.classList.remove('slide-out-left');
                        container.classList.add('slide-in-start-right'); // Start pos for animation
                        
                        // Force reflow
                        void container.offsetWidth; 
                        
                        container.classList.remove('slide-in-start-right');
                    });
                }, 200);
            };

            document.getElementById('btn-next-style').onclick = () => {
                const container = document.getElementById('strip-container');
                // Animate Out Right
                container.classList.add('slide-out-right');
                
                setTimeout(() => {
                    config.styleIndex = (config.styleIndex + 1) % stripStyles.length;
                    updateCarouselUI();
                    generateStrip(() => {
                        container.classList.remove('slide-out-right');
                        container.classList.add('slide-in-start-left');
                        void container.offsetWidth; 
                        container.classList.remove('slide-in-start-left');
                    });
                }, 200);
            };
        }

        function updateCarouselUI() {
            const currentStyle = stripStyles[config.styleIndex];
            document.getElementById('current-style-name').innerText = currentStyle.name;
            
            const dotsContainer = document.getElementById('style-dots');
            dotsContainer.innerHTML = '';
            stripStyles.forEach((_, idx) => {
                const dot = document.createElement('div');
                dot.className = `rounded-circle ${idx === config.styleIndex ? 'bg-light' : 'bg-secondary'}`;
                dot.style.width = '8px';
                dot.style.height = '8px';
                dotsContainer.appendChild(dot);
            });
        }

        function generateStrip(callback) {
            const canvas = document.getElementById('final-canvas');
            const ctx = canvas.getContext('2d');
            const W = 1200;
            const H = 1800;
            
            // Get current style
            const currentStyle = stripStyles[config.styleIndex] || stripStyles[0];

            canvas.width = W;
            canvas.height = H;
            
            // 1. Draw Background using selected style
            currentStyle.draw(ctx, W, H);
            
            const drawColumn = (offsetX) => {
                const stripW = 600;
                const margin = 30;
                const innerW = stripW - (margin*2);
                const photoH = 330;
                const spacing = 30;
                const topM = 50;

                photos.forEach((src, i) => {
                    const img = new Image();
                    img.src = src;
                    const y = topM + (i * (photoH + spacing));
                    
                    // Draw Shadow/Border (using style's border color)
                    ctx.save();
                    ctx.fillStyle = currentStyle.borderColor;
                    ctx.fillRect(offsetX + margin - 2, y - 2, innerW + 4, photoH + 4);
                    ctx.restore();

                    ctx.drawImage(img, offsetX + margin, y, innerW, photoH);
                });

                const logoY = 1550;
                if(config.mode === 'image' && config.logo) {
                    const lImg = new Image();
                    lImg.src = config.logo;
                    const scale = Math.min(innerW/lImg.width, 200/lImg.height);
                    const lw = lImg.width * scale;
                    const lh = lImg.height * scale;
                    ctx.drawImage(lImg, offsetX + (stripW-lw)/2, logoY + (200-lh)/2, lw, lh);
                } else {
                    ctx.fillStyle = currentStyle.textColor;
                    ctx.font = 'bold 48px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(config.text, offsetX + 300, logoY + 100);
                    
                    ctx.font = '24px sans-serif';
                    ctx.fillText(new Date().toLocaleDateString(), offsetX + 300, logoY + 150);
                }
            };
            
            const loadAll = photos.map(src => new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = src; }));
            if(config.mode === 'image' && config.logo) loadAll.push(new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = config.logo; }));

            Promise.all(loadAll).then(async () => {
                // Drawing two strips
                drawColumn(0); // Left Strip
                drawColumn(600); // Right Strip
                
                // Cut line
                ctx.beginPath();
                ctx.setLineDash([20, 20]);
                ctx.strokeStyle = currentStyle.cutLine;
                ctx.lineWidth = 2;
                ctx.moveTo(600, 0);
                ctx.lineTo(600, 1800);
                ctx.stroke();

                const finalData = canvas.toDataURL('image/jpeg', 1.0);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `photobooth-${timestamp}.jpg`;

                document.getElementById('final-image').src = finalData;
                document.getElementById('print-img').src = finalData;
                
                const btnDownload = document.getElementById('btn-download');
                btnDownload.dataset.src = finalData;
                btnDownload.dataset.filename = filename;
                btnDownload.href = "#";

                // --- AUTO SAVE LOGIC ---
                document.getElementById('auto-save-toast').classList.add('hidden'); // Reset toast
                
                if (saveDirectoryHandle) {
                    try {
                        const res = await fetch(finalData);
                        const blob = await res.blob();
                        const fileHandle = await saveDirectoryHandle.getFileHandle(filename, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        
                        const toast = document.getElementById('auto-save-toast');
                        toast.classList.remove('hidden');
                        setTimeout(() => toast.classList.add('hidden'), 5000);
                    } catch (err) {
                        console.error("Auto-save failed", err);
                    }
                }
                
                if(!document.getElementById('view-result').classList.contains('hidden')) {
                    // Only switch view if not already there (prevents redraw flicker loop if logic was different)
                } else {
                    switchView('result');
                }

                if(callback) callback();
            });
        }

        // Manual Save Handler
        document.getElementById('btn-download').onclick = async (e) => {
            e.preventDefault();
            const btn = e.currentTarget;
            if(!btn.dataset.src) return;

            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: btn.dataset.filename,
                    types: [{ description: 'JPEG Image', accept: {'image/jpeg': ['.jpg']} }],
                });
                const writable = await handle.createWritable();
                const response = await fetch(btn.dataset.src);
                await response.body.pipeTo(writable);
            } catch (err) {
                if (err.name !== 'AbortError') {
                     const link = document.createElement('a');
                     link.href = btn.dataset.src;
                     link.download = btn.dataset.filename;
                     document.body.appendChild(link);
                     link.click();
                     document.body.removeChild(link);
                }
            }
        };

        document.getElementById('btn-new-session').onclick = () => {
            switchView('attract');
        };

        init();
    </script>
</body>
</html>
